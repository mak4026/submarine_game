# StatePlayer2(ai_player_nozawa.rb)
## プレイヤーの特徴
StatePlayerを拡張する形で、より複雑なステートの実装を行っている。また、相手から推測されている自艦の位置情報を保持することにより、相手から場所が割られにくいような行動を行う。

## 実装の方法について
### 状態について
StatePlayer2クラスのインスタンス変数@stateに:attack,:sakuteki,:escape,:stealthの4つの状態を保存する。また、関数actionが呼び出されプレイヤーが状態に基づき行動を決めようとする前段階において状態が変更されることもあり、これはグローバルステートとして機能する。それぞれの大まかな動作は以下の通り。
* グローバルステート（actionが呼び出されるたびに必ず一回実行）
  * 自艦が一つしか残っていなかった場合、残っている艦の種別をインスタンス変数@msgに代入し:stealthモードへ移行
  * 現在:stealthないし:escapeモードではなく、敵の位置が特定できている場合はその敵の座標を@msgに代入し:attackモードへ移行
* :sakuteki
  * 通常の状態。基本的に移動を行わず、敵が近くにいると思われる場所を攻撃する。
    * 攻撃場所の決定には評価関数が用いられる。例えば敵の戦艦の場所が10個の候補にまで絞られており、ある場所に攻撃をすることでうち3箇所に水しぶきを上げることができる（攻撃箇所の周囲1マスとなる）場合は、戦艦のスコアは25(マップサイズ)*3/10=7.5となる。これを駆逐艦・潜水艦に対しても計算し合計値を評価値として扱う。
      * なお、攻撃が命中するマスに対しては評価値に1.5倍の倍率がかかる。
    * 連続して索敵モードに入ってから攻撃した場所は保存され、同じ場所は索敵モードにおいては攻撃されない。仮に移動せずに攻撃できる全ての場所を攻撃し尽くしてしまった場合は、また攻撃していない場所を@msgに代入して:attackモードに移行し移動してからの攻撃を試みる。
* :attack
  * 攻撃モード。@msgに代入された座標に攻撃を試みる。
    * 動かずに攻撃が可能な場合は攻撃を行う。
    * 一回の移動で攻撃が可能な場合は、それぞれの自艦につき移動後に相手から推測されるであろう存在可能マス数の二乗を足しあわせ、その値が一番大きかった移動を行う。つまり、できるだけ自艦の情報が相手に漏れずに、また仮に漏れたとしても一部の艦の場所が正確に特定されるよりも複数の艦の場所が大まかに特定されるような状況を選好する。
      * ただし、移動することによってこちらの艦の場所が一箇所に絞られてしまう場合には移動を行わない。
    * 一回の移動で攻撃ができない、もしくはそれが可能ではあるものの移動の結果自艦の場所が一箇所に絞られてしまう場合には二回移動しての攻撃（x軸方向＋y軸方向の移動）を試みる。評価関数は一回の移動の場合と等しい。
      * この場合も移動することによって自艦の場所が一箇所に絞られてしまう場合は移動を行わない。
      	* この制約のため移動が行えなかった場合、:sakutekiモードに移行する。
* :escape
  * @msgに代入されている種類の艦を現在地点から逃走させる。
    * こちらから場所が割れている敵艦の攻撃範囲内に入ってしまう場合にはその場所への移動は行わない。
    * より長く移動し、かつ敵に場所がよりバレていないと考えられるhpの高い味方艦の近くに移動しようとする。
      * 具体的な評価関数は (移動量)*5+(移動した先のマスを攻撃できる味方艦のhp)*(その味方艦が敵に推測されていると思われる存在可能マス数)　である。
    * どの地点に逃げても敵艦の攻撃範囲内に入ってしまう場合は諦めて反撃を行う。近くの敵艦の座標を@msgに代入し:attackモードへ移行する。
* :stealth
  * 潜行モード。自艦が残り一艦となった場合にこのモードに移行し、確実に敵に攻撃が当たると分かっている場合以外は移動を行う。
    * できるだけ長く移動し、かつ移動によって相手への情報漏洩が少ないと思われるような座標値へ移動を行う。
      * 評価関数は(移動量)+(移動後に相手に推測されると思われる存在可能マス数)/(移動前の相手に推測されていると思われる存在可能マス数)*25 である。
      * できるだけ長く移動すべきかどうかについては諸説あると思われるが、ここでは移動量が大きいほど相手はその艦の追跡のために移動を強いられそこで相手の位置情報の漏洩が起こりうる、という想定に基づいている。
    * こちらから場所が割れている敵艦の攻撃範囲にどうしても入ってしまう場合は:sakutekiへと移行する。

### サーバーからの応答に基づく処理
#### 自ターンの処理
* 攻撃した際に返ってきた情報に基づき、敵がいると思われる場所が格納されたデータ@enemy_fieldを更新する。

#### 相手ターンの処理
* 相手の攻撃が自艦に命中した場合、:attackないし:escapeモードに移行する。
* 敵艦の位置が特定できており、自艦のhpが敵艦のhp以上であった場合は反撃を行う。@msgに敵艦の座標を代入し@stateを:attackへと変更する。
  * それ以外の場合は、@msgに攻撃された自艦の種類を代入し@stateを:escapeへと変更する。
* 相手が攻撃してきた場所及びそれによって漏れた情報から、*相手から見た自艦の存在可能位置*が格納されたデータ@my_fieldを更新する。